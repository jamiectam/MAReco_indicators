---
title: "Untitled"
author: "Jamie"
date: "2024-04-30"
output: html_document
---

This document consolidates the steps from SSdata to marinidicators for calculating ecological indicators from the Maritimes Region.


```{r}

#setup
require(devtools)
#require(SSdata)
require(RODBC)
require(here)
require(tidyverse)
require(Rtools)
require(readxl)
require(remotes)
install_github("dempseydanielle/marindicators")
require(missForest)
# remotes::install_github("jamiectam/SSdata@<c386abc3887f012cec087db5d00d06a4ff264baa>")
remotes::install_github("dempseydanielle/SSdata")

```

Setup parameters
```{r}
path<-file.path(here())
start.year <- 2023 #recommend just updating one or 2 years to save time
end.year <- 2025
areas.RV <- c("esswss", "shelf", "nafo", "strat")
areas.land <- c("esswss", "shelf", "nafo")

```


which requires username and password for accessing database
channel= odbcConnect("ptran", uid = "###", pwd = "###")

# Replace biomassData function 
```{r}
biomassData <- function(path, s.strat = 440, e.strat = 495, s.year, e.year,
                        vessel.correction = TRUE) {
  
  # display error message if s.strat or e.start are < 440 or > 495
  if(s.strat < 440 | s.strat > 495 | e.strat < 440 | e.strat > 495) {
    stop("error: s.strat or e.strat is outside of the Scotian Shelf")
  }
  
  # vector of years of interest
  yr <- s.year:e.year
  
  # start loop over years
  for(i in 1:length(yr)) {            
    
    # At Length ---------------------------------------------------------------
    
    # Table with "SPECIES", "FUNGROUP", "Q", "LENCORR" (88 observations)
    catch_coefs <- sqlQuery(channel, paste('select * from gomezc.indiseas_catchability_coeffs'))
    # replaced sql database query with the file in the data folder
    # catch_coefs<-INDISEAS_CATCHABILITY_COEFFS #####didn't work, try again later
    catch_coefs[catch_coefs == 'NULL'] <- NA
    outputs <- list()
    m = 0
    
    # Extract table with 12 columns: 
    ## YEAR, STRAT, MISSION, YYDDMMSS, XDDMMSS, SETNO, FLEN, 
    ## ABUNDANCE, QABUNDANCE, QBIOMASS, BIOMASS, SPECIES
    # QABUNDANCE and QBIOMASS are q-adjusted at the set level (BEFORE stratification). 
    for (j in 1:nrow(catch_coefs)) {
      outputs[[j]] <- qBiomass(species = catch_coefs[j, 1], fun_group = catch_coefs[j, 2], 
                               q = catch_coefs[j, 3], len_corr = catch_coefs[j, 4], year = yr[i]) 
    }
    out <- as.data.frame(do.call(rbind, outputs))
    out <- out[, -which(names(out) %in% c('YDDMMSS', 'XDDMMSS'))]  # remove lat/long columns
    
    if(vessel.correction) out <- vesselCorr(out)                   # apply vessel correction
    
    # Export length based data (biomass and abundance at 1 cm intervals)
    fna <- paste(path,"/data/length/",sep="")
    dir.create(fna, recursive = T, showWarnings = F)
    fna <- paste(fna, "num_biom_at_length", yr[i], ".RData", sep = "")
    save(out, file = fna, compress = T)
    
    # End of At Length ------------------------------------------------------
    
    # Begin aggregate ---------------------------------------------------------
    # Sum over length (aggregated biomass & abundance of species that have length-based q)
    ag.out <- aggregate(cbind(QBIOMASS, BIOMASS, QABUNDANCE, ABUNDANCE) ~ 
                          YEAR + STRAT + MISSION + SETNO + SPECIES, 
                        data = out, FUN = sum)
    
    # Extract table with 7 columns:
    ## MISSION, SETNO, STRAT, YEAR, SPEC, ABUNDANCE, BIOMASS
    dat <- sqlQuery(channel,paste("select distinct i.mission,i.setno,i.strat, to_char(sdate,'yyyy') year, spec,sum(nvl(totno,0)*1.75/i.dist) Abundance,sum(nvl(totwgt,0)*1.75/i.dist) biomass from 
                            groundfish.gsinf i, groundfish.gscat c, gomezc.nafo_strat sg where i.mission=c.mission and i.setno=c.setno and i.strat=sg.strat and to_char(sdate,'mm') in ('06','07','08') and
                            i.strat between '",s.strat,"' and '",e.strat,"' and type=1 and spec<9000 and to_char(sdate,'yyyy')=",yr[i],"
                            group by i.mission,i.setno,i.strat,slat , slong ,to_char(sdate,'yyyy'), spec;",sep=""))
    
    # Fix high biomass estimate(s) for dogfish
    dat[dat$BIOMASS > 8000 & dat$SPEC != 220,'BIOMASS'] <- 0 # added in November 08, 2013 
    
    # Change NA for abundance or biomass based on mean size of animals captured (for invs only)
    dat[is.na(dat$ABUNDANCE), 'ABUNDANCE'] <- 0
    dat[is.na(dat$BIOMASS), 'BIOMASS'] <- 0
    
    # Handle the missing biomass or abudance data where the other is present
    # by using mean weight = biomass/abundance
    if(any(dat$ABUNDANCE == 0 | dat$BIOMASS==0)) {
      
      wt <- sqlQuery(channel, paste("select * from mean_wts_for_fill_in;",sep="")) # table of mean fish weight ("SPEC" and "MEAN_WT_FISH", 640 observations)
      dat <- merge(dat, wt, by = c('SPEC'), all.x = T)                             # merge dat and wt
      dat[is.na(dat$MEAN_WT_FISH), 'MEAN_WT_FISH'] <- 0.5                          # if mean fish weight is NA, assign mean weight of 0.5
      
      if(any(dat$ABUNDANCE == 0)) {
        dat$ABUNDANCE[dat$ABUNDANCE == 0] <- dat$BIOMASS[dat$ABUNDANCE==0]/dat$MEAN_WT_FISH[dat$ABUNDANCE==0] # abundance = biomass/mean weight  			
      } # DD added this bracket so that biomass correction is OUTSIDE of the if statement for abundance
      if(any(dat$BIOMASS == 0)) {
        dat$BIOMASS[dat$BIOMASS == 0] <- dat$ABUNDANCE[dat$BIOMASS==0]*dat$MEAN_WT_FISH[dat$BIOMASS==0]					
      }
    }
    
    # Change ABUNDANCE = inf to ABUNDANCE = 1 
    if(unique(dat$YEAR)==2012 & any(!is.finite(dat$ABUNDANCE))) dat[which(!is.finite(dat$ABUNDANCE)),'ABUNDANCE'] <- 1
    
    # If any biomass or abundance is still NA, stop code
    if(any(is.na(dat[,c('BIOMASS','ABUNDANCE')]))) browser()
    
    # Replace 0's with small values
    dat[dat$BIOMASS == 0 ,'BIOMASS'] <- 0.01	
    dat[dat$ABUNDANCE == 0 ,'ABUNDANCE'] <- 1
    
    dat$QABUNDANCE <- dat$ABUNDANCE 
    dat$QBIOMASS <- dat$BIOMASS
    dat$SPECIES <- dat$SPEC       # need this line? Drop SPECIES column at line 145
    if(vessel.correction) dat <- vesselCorr(dat) # Apply vessel correction
    dat <- dat[, -which(names(dat) == 'SPECIES')]
    
    # Add in zero sets. 
    # These are needed to calculate the stratified means
    extra.sets <- sqlQuery(channel,paste("select distinct i.mission,i.setno,i.strat,to_char(sdate,'yyyy') year from groundfish.gsinf i, nafo_strat sg where 
			i.strat=sg.strat and to_char(sdate,'yyyy') =",yr[i]," and to_char(sdate,'mm') in ('06','07','08') and i.strat between '",s.strat,"' and '",e.strat,"' and type=1;",sep=""))
    s <- unique(dat$SPEC)	
    m <- matrix(0, nrow = dim(extra.sets)[1], ncol=length(s),
                dimnames = list(c(1:nrow(extra.sets)), s))	
    m <- cbind(extra.sets, m)
    h <- melt(m, id = c("MISSION", "SETNO", "STRAT", "YEAR"))
    names(h)[which(names(h) %in% c('variable','value'))] <- c('SPECIES','BIOMASS')
    h$QBIOMASS <- h$QABUNDANCE <- h$MEAN_WT_FISH <- h$ABUNDANCE <- 0
    names(dat)[1] <- 'SPECIES'
    
    l <- rbind(dat, h, all = T) # not sure why need all = T. This adds an extra
    # row where MISSION = TRUE and SPECIES = TRUE (other columns = 1).
    # I remove this row below
    
    dat <- l[!duplicated(l[,c('MISSION','SETNO','SPECIES')], fromLast = F),]
    dat <- dat[-which(dat$MISSION == TRUE), ] # remove row where MISSION == TRUE
    
    # Add in the qadjusted data
    dat1 <- dat
    w <- merge(dat, ag.out, by = c('MISSION','SETNO','STRAT','SPECIES','YEAR'), all.x = T)	
    # Add columns for ABUNDANCE, QABUNDANCE, BIOMASS, and QBIOMASS
    w$ABUNDANCE <- 0		
    w$QABUNDANCE <- 0		
    w$BIOMASS <- 0		
    w$QBIOMASS <- 0		
    
    # Fill in columns for ABUNDANCE, QABUNDANCE, BIOMASS, and QBIOMASS with appropriate data
    # .x is from dat (not q adj); .y is from ag.out (qadj)
    w$ABUNDANCE <- ifelse(is.na(w$ABUNDANCE.y), w$ABUNDANCE.x, w$ABUNDANCE.y)
    w$BIOMASS <- ifelse(is.na(w$BIOMASS.y), w$BIOMASS.x, w$BIOMASS.y)
    w$QABUNDANCE <- ifelse(is.na(w$QABUNDANCE.y), w$QABUNDANCE.x, w$QABUNDANCE.y)
    w$QBIOMASS <- ifelse(is.na(w$QBIOMASS.y), w$QBIOMASS.x, w$QBIOMASS.y)
    
    # Export aggregated data
    dat <- w[, c('MISSION','SETNO','SPECIES','YEAR','STRAT','ABUNDANCE','BIOMASS','QABUNDANCE','QBIOMASS')]		
    fna <- paste(path,"/data/aggregate/",sep="")
    dir.create(fna, recursive = T, showWarnings = F)
    save(dat, file = paste(fna, "num_biom", yr[i], ".RData", sep=""))
    
    rm(dat, w)
    
    print(paste("biomassData() function: finished year", yr[i]))
  } # end of loop over years
  
} # end of function

vesselCorr <- function(x) {
  
  cf = NULL
  x$CFVESSEL = 1  # initialise
  
  # vessel change correction factors apply to these years:
  HAM=1   #  Lady Hammond (1979 - 1981)
  ATC=2   #  A.T. Cameron (1982 - 1983)
  
  # species codes used by the database
  cod=10
  haddock=11
  whitehake=12
  silverhake=14
  plaicelarge=40
  plaicesmall=40
  witch=41
  yellowtail=42
  winterflounder=43
  cf$cod[HAM]         = 0.8
  cf$haddock[HAM]     = 1.0
  cf$whitehake[HAM]   = 1.0
  cf$silverhake[HAM]  = 1.0
  cf$plaicesmall[HAM] = 1   # <=28cm
  cf$plaicelarge[HAM] = 1   # > 28cm
  cf$witch[HAM]       = 0.8
  cf$yellowtail[HAM]  = 0.8
  cf$winterflounder[HAM] = 1.0
  cf$cod[ATC]         = 0.8
  cf$haddock[ATC]     = 1.2
  cf$whitehake[ATC]   = 1.0
  cf$silverhake[ATC]  = 1.0
  cf$plaicesmall[ATC] = 0.7
  cf$plaicelarge[ATC] = 1.0
  cf$witch[ATC]       = 0.8
  cf$yellowtail[ATC]  = 0.8
  cf$winterflounder[ATC] = 1.0
  attach (x)
  x$CFVESSEL[ which( (substring(MISSION,1,3)=="HAM" & SPECIES==cod)) ] = cf$cod[HAM]
  x$CFVESSEL[ which((substring(MISSION,1,3)=="HAM" & SPECIES==witch)) ] = cf$witch[HAM]
  x$CFVESSEL[ which((substring(MISSION,1,3)=="HAM" & SPECIES==yellowtail)) ] = cf$yellowtail[HAM]
  x$CFVESSEL[ which((substring(MISSION,1,3)=="ATC" & SPECIES==cod)) ] = cf$cod[ATC]
  x$CFVESSEL[ which((substring(MISSION,1,3)=="ATC" & SPECIES==haddock)) ] = cf$haddock[ATC]
  x$CFVESSEL[ which((substring(MISSION,1,3)=="ATC" & SPECIES==plaicesmall && FLEN<=28)) ] = cf$plaicesmall[ATC]
  x$CFVESSEL[ which((substring(MISSION,1,3)=="ATC" & SPECIES==witch)) ] = cf$witch[ATC]
  x$CFVESSEL[ which((substring(MISSION,1,3)=="ATC" & SPECIES==yellowtail)) ] = cf$yellowtail[ATC]
  detach (x)
  x$BIOMASS = x$BIOMASS * x$CFVESSEL #similar coefficients in manning 1985      
  x$ABUNDANCE = x$ABUNDANCE * x$CFVESSEL
  if(any(names(x) %in% c('QBIOMASS','QABUNDANCE'))) {
    x$QBIOMASS = x$QBIOMASS * x$CFVESSEL #similar coefficients in manning 1985      
    x$QABUNDANCE = x$QABUNDANCE * x$CFVESSEL
  }
  x <- x[,-which(names(x)=='CFVESSEL')]
  return (x)
}


```


## Update biomass and landings data
```{r}
#extracts RV survey data, requires passwords 
biomassData(path=path, 
            s.strat = 440, 
            e.strat = 495, 
            s.year=start.year, 
            e.year=end.year, 
            vessel.correction = TRUE)

#resulting Rdata files should go into the correct folder (have not yet tested) 

extractLAND(path=path,
              e.year = end.year)

```


## Calculate dataframes for specific areas                       
```{r}
#can also use update_LAND=TRUE

LANDdataframe(path=path, areas = c("shelf", "esswss", "nafo"), update_LAND=FALSE,
           e.year=end.year, csv = TRUE, rdata = TRUE)

stratifyBiomass(path=path, s.year=start.year, e.year=end.year, areas=areas.RV,
                lengthbased=TRUE, 
                 qadjusted=TRUE)

stratifyBiomass(path=path, s.year=start.year, e.year=end.year, areas=areas.RV,
                lengthbased=TRUE, 
                 qadjusted=FALSE)

stratifyBiomass(path=path, s.year=start.year, e.year=end.year, areas=areas.RV,
                lengthbased=FALSE, 
                 qadjusted=TRUE)

stratifyBiomass(path=path, s.year=start.year, e.year=end.year, areas=areas.RV,
                lengthbased=FALSE, 
                 qadjusted=FALSE)

RVdataframe(path = path, s.year = start.year, e.year = end.year, areas = areas.RV,
            lengthbased = TRUE,
            qadjusted = TRUE,
            update_RV = FALSE,
            csv = TRUE, rdata = TRUE)

RVdataframe(path = path, s.year = start.year, e.year = end.year, areas = areas.RV,
            lengthbased = TRUE,
            qadjusted = FALSE,
            update_RV = FALSE,
            csv = TRUE, rdata = TRUE)

RVdataframe(path = path, s.year = start.year, e.year = end.year, areas = areas.RV,
            lengthbased = FALSE,
            qadjusted = TRUE,
            update_RV = FALSE,
            csv = TRUE, rdata = TRUE)

RVdataframe(path = path, s.year = start.year, e.year = end.year, areas = areas.RV,
            lengthbased = FALSE,
            qadjusted = FALSE,
            update_RV = FALSE,
            csv = TRUE, rdata = TRUE)

LWdataframe(path=path, s.year=start.year, e.year=end.year, areas = c("shelf", "esswss", "nafo","strat"), update_LW = FALSE, csv = TRUE, rdata = TRUE)

```
                        
                        
## Update herring                          
```{r}
path <- file.path(here())

source(paste(path, "/Extra Info/convert_herring_length.R", sep = ""))

length.cutoff <- 23

# IMPORT DATA -------------------------------------------------------------

# adjusted-VPA biomass index 
# Replaced VPA biomass index with SSB model output from a Statistical catch at age model from the MSE from Allan Debertin. Added column SSB_tonnes
adj_dat <- read.csv(paste(path, "/output/RV/herring_data/herring_biomass_adjusted.csv", sep = "")) 
adj_VPA <- adj_dat %>% 
  filter(YEAR >= 1970, YEAR < 2021) %>%  # filter for years >= 1970 & years < 1999 CHANGED to 2020 to align with SSB data
  mutate(BIOMASS = SSB_tonnes * 1000) %>%   # convert from tonnes to kg
  rename("BIOMASS_INDEX" = "BIOMASS")    # rename biomass column to differentiate from RV BIOMASS

# acoustic abundance at length: numbers (millions) at length (cm)
acoustic.abund <- read_excel(paste(
  path, "/output/RV/herring_data/Acoustic Number and Biomass at Length_200313.xlsx", sep = ""), sheet = 2)
acoustic.abund.tidy <- pivot_longer(acoustic.abund, 
                                    cols = c(2:ncol(acoustic.abund)), 
                                    names_to = "LENGTH", values_to = "ABUNDANCE") %>% 
  rename("YEAR" = "Year") %>% 
  mutate(ABUNDANCE = ABUNDANCE * 10^6, LENGTH = as.numeric(LENGTH))  # convert to numbers

# acoustic biomass at length: weight (metric tonnes) at length (cm)
acoustic.bio <- read_excel(paste(
  path, "/output/RV/herring_data/Acoustic Number and Biomass at Length_200313.xlsx", sep = ""), sheet = 3)
acoustic.bio.tidy <- pivot_longer(acoustic.bio, 
                                  cols = c(2:ncol(acoustic.bio)), 
                                  names_to = "LENGTH", values_to = "BIOMASS") %>% 
  rename("YEAR" = "Year") %>% 
  mutate(BIOMASS = BIOMASS * 10^3, LENGTH = as.numeric(LENGTH)) # convert to weight in kg

# Join biomass and abundance data
acoustic <- full_join(acoustic.bio.tidy, acoustic.abund.tidy, by = c("YEAR", "LENGTH")) %>% 
  filter(LENGTH >= length.cutoff)  # subset for lengths >= 23 cm

###########################################################################
# WSS Scale ---------------------------------------------------------------
###########################################################################

# Import and tidy stratified RV data at the WSS scale
RV_wss <- read.csv(paste(path, "/output/RV/esswss/esswss_lengthbased_notqadj.csv", sep = "")) %>% 
  filter(SPECIES == 60,                # subset for herring
         ID == "WSS",                  # subset for WSS
         YEAR >= 1970, 
         YEAR < 2021) %>%              # subset for years < 1999 (acoustic data used after 1999)
  convert_herring_length() %>%         # convert all lengths to total length in cm
  select(-ID, -SPECIES) %>%
  filter(LENGTH >= length.cutoff)      # subset for lengths >= 23 cm (mature fish)

###############
## Aggregate ##
###############

### Before 1999

# Calculate annual mean weight (kg) from RV data
MEAN_WT <- RV_wss %>% 
  group_by(YEAR) %>% 
  summarise(BIOMASS = sum(BIOMASS), ABUNDANCE = sum(ABUNDANCE)) %>% # total biomass and abundance each year
  mutate(MEAN_WT = BIOMASS/ABUNDANCE) %>%                           # mean weight each year
  select(-BIOMASS, -ABUNDANCE)

# Merge adjusted-VPA index with annual mean weight and calculate abundance
adj_agg <- full_join(adj_VPA, MEAN_WT, by = "YEAR") %>% 
  mutate(ABUNDANCE = BIOMASS_INDEX / MEAN_WT) %>% 
  select(-MEAN_WT) %>% 
  rename("BIOMASS" = "BIOMASS_INDEX")

rm(MEAN_WT)

######
#DON'T USE BELOW after sub for SSB data from MSE outputs instead of acoustic
########

### After 1999

# # Sum biomass and abundance over all length classes each year
# acoustic_agg <- acoustic %>%  
#   group_by(YEAR) %>% 
#   summarize(BIOMASS = sum(BIOMASS), ABUNDANCE = sum(ABUNDANCE))
# 
# # Total biomass and abundance indices for WSS:
# HER_agg_wss <- rbind(adj_agg, acoustic_agg)

###############
## Length #####
###############

### Before 1999:
  
# Calculate mean weight (kg) at length (cm) from RV data 
MEAN_WT_length <- RV_wss %>% mutate(MEAN_WT = BIOMASS/ABUNDANCE) %>% 
  select(-BIOMASS, -ABUNDANCE)

# Calculate propotion of total biomass at each length from RV data;
# Allocate the biomass index into length classes based on RV proportions;
# Calculate abundance from mean weight
adj_length <- RV_wss %>%  select(-ABUNDANCE) %>% 
  group_by(YEAR) %>% 
  mutate(TOTAL_BIOMASS = sum(BIOMASS))%>%            # total biomass each year
  ungroup() %>% 
  mutate(PROP_BIOMASS = BIOMASS/TOTAL_BIOMASS) %>%   # proportion of total biomass at each length
  full_join(adj_VPA, by = "YEAR") %>%                # merge with adjusted-VPA index        
  mutate(BIOMASS_INDEX_LENGTH = PROP_BIOMASS * BIOMASS_INDEX) %>%  # allocate adjusted-VPA index into length classes
  select(YEAR, LENGTH, BIOMASS_INDEX_LENGTH) %>% 
  left_join(MEAN_WT_length, by = c("YEAR", "LENGTH")) %>%          # merge with mean weight dataframe
  mutate(ABUNDANCE_INDEX_LENGTH = BIOMASS_INDEX_LENGTH / MEAN_WT) %>%   # calculate abundance
  rename("BIOMASS" ="BIOMASS_INDEX_LENGTH", "ABUNDANCE" = "ABUNDANCE_INDEX_LENGTH") %>% 
  select(-MEAN_WT) 

rm(MEAN_WT_length)

### After 1999:
  
# Acoustic data

# # Biomass and abundance indices at length for WSS:
# HER_length_wss <- rbind(adj_length, acoustic)
HER_length_wss<-adj_length

###########################################################################
# Strata Scale ------------------------------------------------------------
###########################################################################

# Import and tidy stratified RV data at the strata scale. 
RV_strat <- read.csv(paste(path, "/output/RV/strat/strat_lengthbased_notqadj.csv", sep = "")) %>% 
  filter(SPECIES == 60,                  # subset for herring
         ID >= 470,                      # subset for strata on the WSS
         YEAR >= 1970,                 
         YEAR <= 2022) %>% 
  convert_herring_length() %>%           # convert all lengths to total length in cm
  filter(LENGTH >= length.cutoff) %>%    # subset for lengths >= 23 cm
  select(-SPECIES)

# Calculate proportion of total biomass and abundance in each strata from RV data
RV_prop <- RV_strat %>%  
  group_by(YEAR, ID) %>% 
  summarise(BIOMASS = sum(BIOMASS), ABUNDANCE = sum(ABUNDANCE))%>%           # total biomass in each strata for each year
  ungroup() %>% 
  group_by(YEAR) %>%            
  mutate(TOTAL_BIOMASS = sum(BIOMASS), TOTAL_ABUNDANCE = sum(ABUNDANCE)) %>% # total biomass each year
  ungroup() %>% 
  # proportion of total biomass and abundance in each strata
  mutate(PROP_BIOMASS = BIOMASS/TOTAL_BIOMASS, PROP_ABUNDANCE = ABUNDANCE/TOTAL_ABUNDANCE) %>% 
  select(YEAR, ID, PROP_BIOMASS, PROP_ABUNDANCE)

###############
## Aggregate ##
###############

### Before 1999:
  
# Calculate annual mean weight (kg) for each strata from RV data 
MEAN_WT <- RV_strat %>% filter(YEAR < 1999) %>% 
  group_by(YEAR, ID) %>% 
  summarise(BIOMASS = sum(BIOMASS), ABUNDANCE = sum(ABUNDANCE)) %>% 
  mutate(MEAN_WT = BIOMASS/ABUNDANCE) %>% 
  select(-BIOMASS, -ABUNDANCE) %>%  
  ungroup() 

# Allocate the adjusted biomass index into each strata and then calculate abundance
adj_agg_strat <- inner_join(RV_prop, adj_VPA, by = "YEAR") %>%          # merge RV proportions with adjusted-VPA data
  mutate(BIOMASS_INDEX_STRAT = PROP_BIOMASS * BIOMASS_INDEX) %>%        # allocate biomass index into each strata
  select(YEAR, ID, BIOMASS_INDEX_STRAT) %>% 
  inner_join(MEAN_WT, by = c("YEAR", "ID")) %>%                         #  merge with mean weight dataframe
  mutate(ABUNDANCE_INDEX_STRAT = BIOMASS_INDEX_STRAT / MEAN_WT) %>%     # calculate abundance index
  rename("BIOMASS" ="BIOMASS_INDEX_STRAT", "ABUNDANCE" = "ABUNDANCE_INDEX_STRAT") %>% 
  select(-MEAN_WT) 

### After 1999:
  
# Sum biomass and abundance over all length classes and then allocate biomass and abundance into strata
acoustic_agg_strat <- acoustic %>%  
  group_by(YEAR) %>% 
  summarize(BIOMASS = sum(BIOMASS), ABUNDANCE = sum(ABUNDANCE)) %>%  # total biomass and abundance each year
  inner_join(RV_prop, by = "YEAR") %>%                                # merge RV proportions with acoustic data
  # allocate biomass and abundance into strata based on RV proportions
  mutate(BIOMASS = BIOMASS * PROP_BIOMASS, ABUNDANCE = ABUNDANCE * PROP_ABUNDANCE) %>% 
  select(YEAR, ID, BIOMASS, ABUNDANCE)

# # Total biomass and abundance indices at for each strata on WSS:
# HER_agg_strat <- rbind(adj_agg_strat, acoustic_agg_strat)
HER_agg_strat<-adj_agg_strat #use only data calculated from SSB model

###############
## Length #####
###############

### Before 1999:
  
# Calculate proportion of RV biomass and abundance in each strata and length class
RV_prop_length <- RV_strat %>% 
  # filter(YEAR < 1999) %>%
  group_by(YEAR) %>% 
  # total biomass & abundance over all strata & length classes
  mutate(TOTAL_BIOMASS = sum(BIOMASS), TOTAL_ABUNDANCE = sum(ABUNDANCE)) %>%                   
  ungroup() %>% 
  # proportion of total biomass and abundance in each strata and length class
  mutate(PROP_BIOMASS = BIOMASS/TOTAL_BIOMASS, PROP_ABUNDANCE = ABUNDANCE/TOTAL_ABUNDANCE) %>% 
  select(YEAR, ID, LENGTH, PROP_BIOMASS, PROP_ABUNDANCE)

# Calculate mean weight (kg) at length (cm) from RV data 
MEAN_WT_length <- RV_strat %>%  
  # filter(YEAR < 1999) %>% 
  mutate(MEAN_WT = BIOMASS/ABUNDANCE) %>% 
  select(-BIOMASS, -ABUNDANCE)

# Allocate the adjusted-VPA biomass index into each strata and length class and then calculate abundance
adj_length <-  inner_join(RV_prop_length, adj_VPA, by = "YEAR") %>%     
  # allocate biomass index into each strata & length class based on RV propotions
  mutate(BIOMASS_INDEX_STRAT = PROP_BIOMASS * BIOMASS_INDEX) %>%      
  select(YEAR, ID, LENGTH, BIOMASS_INDEX_STRAT) %>% 
  inner_join(MEAN_WT_length, by = c("YEAR", "ID", "LENGTH")) %>%     # merge with mean weight dataframe
  mutate(ABUNDANCE_INDEX_STRAT = BIOMASS_INDEX_STRAT / MEAN_WT) %>%  # calculate abundance
  rename("BIOMASS" ="BIOMASS_INDEX_STRAT", "ABUNDANCE" = "ABUNDANCE_INDEX_STRAT") %>% 
  select(-MEAN_WT) 

### After 1999:

# Use RV data to calculate proportion of biomass and abundance from each length class in each strata. 
## (Note: this is NOT the same as in Before 1999. Before 1999, we allocate the total biomass into strata and length class. 
## Here, we allocate the biomass in a given length class into each strata.)
RV_length_acoustic <- RV_strat %>%  
  group_by(YEAR, LENGTH) %>% 
  # total biomass and abundance in each length class (sum over all strata)
  mutate(BIOMASS_LENGTH = sum(BIOMASS), ABUNDANCE_LENGTH = sum(ABUNDANCE)) %>% 
  ungroup() %>% 
  # proportion of biomass and abundance from each length class in each strata
  mutate(PROP_BIOMASS = BIOMASS/BIOMASS_LENGTH, PROP_ABUNDANCE = ABUNDANCE/ABUNDANCE_LENGTH) %>% 
  select(YEAR, ID, LENGTH, PROP_BIOMASS, PROP_ABUNDANCE)

# Allocate the biomass and abundance at each length into strata
acoustic_length <- acoustic %>% 
  inner_join(RV_length_acoustic, by = c("YEAR", "LENGTH"))%>% 
  mutate(BIOMASS = BIOMASS * PROP_BIOMASS, ABUNDANCE = ABUNDANCE * PROP_ABUNDANCE) %>% 
  select(YEAR, ID, LENGTH, BIOMASS, ABUNDANCE)

# # Biomass and abundance indices at length for each strata on WSS:
# HER_length_strat <- rbind(adj_length, acoustic_length)
HER_length_strat<-adj_length



# Export ------------------------------------------------------------------

dir.create(paste(path, "/output/RV/herring_output", sep = ""), recursive = FALSE, showWarnings = T)

save(HER_agg_wss, 
          file = paste(path, "/output/RV/herring_output/wss_notlengthbased_herring_SSB.Rdata", sep = ""))

save(HER_length_wss, 
          file = paste(path, "/output/RV/herring_output/wss_lengthbased_herring_SSB.Rdata", sep = ""))

save(HER_agg_strat, 
          file = paste(path, "/output/RV/herring_output/strat_notlengthbased_herring_SSB.Rdata", sep = ""))

save(HER_length_strat, 
          file = paste(path, "/output/RV/herring_output/strat_lengthbased_herring.Rdata", sep = ""))

```
  
## Merge RV and herring
```{r}
path <- file.path(here())

source(paste(path, "/Extra Info/convert_herring_length.R", sep = ""))

#  WSS AGG ---------------------------------------------------------

# # herring index: add ID and SPECIES columns
# HER_wss_agg <- read_csv(paste(path, "/output/RV/herring_output/wss_notlengthbased_herring.csv", sep = "")) %>% 
#   mutate(ID = "WSS", SPECIES = 60)
#changed to use model SSB derived herring 
HER_wss_agg<-HER_agg_wss |> 
    mutate(ID = "WSS", SPECIES = 60)

# RV data
esswss_agg <- read_csv(paste(path, "/output/RV/esswss/esswss_notlengthbased_qadj.csv", sep = ""))

# ess: no changes
ess_agg <- esswss_agg %>% filter(ID == "ESS")

# wss: remove RV herring observations and add index
wss_agg <- esswss_agg %>% filter(ID == "WSS", SPECIES != 60) %>% 
  rbind(HER_wss_agg)

# put ESS and WSS back together
esswss_agg_OUT <- rbind(ess_agg, wss_agg)


#  WSS LENGTH ---------------------------------------------------------

# # herring index: add ID and SPECIES columns
# HER_wss_length <- read_csv(paste(path, "/output/RV/herring_output/wss_lengthbased_herring.csv", sep = ""))  %>% 
#   mutate(ID = "WSS", SPECIES = 60)
#changed to use model SSB derived herring 
HER_wss_length<-HER_length_wss |> 
    mutate(ID = "WSS", SPECIES = 60)

# RV data
esswss_length <-  read_csv(paste(path, "/output/RV/esswss/esswss_lengthbased_qadj.csv", sep = ""))

# ess: convert herring lengths to total length in cm
ess_length <- esswss_length %>% filter(ID == "ESS") %>% 
  convert_herring_length()

# wss: remove RV herring observations and add index
wss_length <- esswss_length %>% filter(ID == "WSS", SPECIES != 60) %>% 
  rbind(HER_wss_length)

# put ESS and WSS back together
esswss_length_OUT <- rbind(ess_length, wss_length)


#  NAFO AGG ---------------------------------------------------------

# # herring index: 4X is the same as WSS
# HER_4X_agg <- read_csv(paste(path, "/output/RV/herring_output/wss_notlengthbased_herring.csv", sep = "")) %>% 
#   mutate(ID = "4X", SPECIES = 60)
HER_4X_agg<-HER_agg_wss |> 
    mutate(ID = "4X", SPECIES = 60)

# RV data
nafo_agg <- read_csv(paste(path, "/output/RV/nafo/nafo_notlengthbased_qadj.csv", sep = ""))

# 4VN, 4VS, 4W: no changes
VW_agg <- nafo_agg %>% filter(ID != "4X")

# 4X: remove RV herring observations and add index
X_agg <- nafo_agg %>% filter(ID == "4X", SPECIES != 60) %>% 
  rbind(HER_4X_agg)

# put ESS and WSS back together
nafo_agg_OUT <- rbind(VW_agg, X_agg)


#  NAFO LENGTH ---------------------------------------------------------

# # herring index: add ID and SPECIES columns
# HER_4X_length <- read_csv(paste(path, "/output/RV/herring_output/wss_lengthbased_herring.csv", sep = ""))  %>% 
#   mutate(ID = "4X", SPECIES = 60)
HER_4X_length<-HER_length_wss |> 
    mutate(ID = "4X", SPECIES = 60)

# RV data
nafo_length <-  read_csv(paste(path, "/output/RV/nafo/nafo_lengthbased_qadj.csv", sep = ""))

# 4VN, 4VS, 4W: convert herring lengths to total length in cm
VW_length <- nafo_length %>% filter(ID != "4X") %>% 
  convert_herring_length()

# wss: remove RV herring observations and add index
X_length <- nafo_length %>% filter(ID == "4X", SPECIES != 60) %>% 
  rbind(HER_4X_length)

# put ESS and WSS back together
nafo_length_OUT <- rbind(VW_length, X_length)


#  strat AGG ---------------------------------------------------------

# herring index: add SPECIES columns
# HER_strat_agg <- read_csv(paste(path, "/output/RV/herring_output/strat_notlengthbased_herring.csv", sep = "")) %>% 
#   mutate(SPECIES = 60)

HER_strat_agg<-HER_agg_strat |> 
    mutate(SPECIES = 60)

# RV data
strat_agg <- read_csv(paste(path, "/output/RV/strat/strat_notlengthbased_qadj.csv", sep = ""))

# ess: no changes
ess_strat_agg <- strat_agg %>% filter(ID < 470)

# strat: remove RV herring observations and add index
wss_strat_agg <- strat_agg %>% filter(ID >= 470, SPECIES != 60) %>% 
  rbind(HER_strat_agg)

# put ESS and strat back together
strat_agg_OUT <- rbind(ess_strat_agg, wss_strat_agg)


#  strat LENGTH ---------------------------------------------------------

# # herring index: add SPECIES columns
# HER_strat_length <- read_csv(paste(path, "/output/RV/herring_output/strat_lengthbased_herring.csv", sep = "")) %>% 
#   mutate(SPECIES = 60)

HER_strat_length<-HER_length_strat |> 
    mutate(SPECIES = 60)

# RV data
strat_length <- read_csv(paste(path, "/output/RV/strat/strat_lengthbased_qadj.csv", sep = ""))

# ess: convert herring lengths to total length in cm
ess_strat_length <- strat_length %>% filter(ID < 470) %>% 
   convert_herring_length()

# strat: remove RV herring observations and add index
wss_strat_length <- strat_length %>% filter(ID >= 470, SPECIES != 60) %>% 
  rbind(HER_strat_length)

# put ESS and strat back together
strat_length_OUT <- rbind(ess_strat_length, wss_strat_length)



# Export ------------------------------------------------------------------

dir.create(paste(path, "/final_output", sep = ""), recursive = FALSE, showWarnings = FALSE)

write_csv(esswss_agg_OUT,
          path = paste(path, "/final_output/esswss_notlengthbased_qadj_final.csv", sep = ""))

write_csv(esswss_length_OUT,
          path = paste(path, "/final_output/esswss_lengthbased_qadj_final.csv", sep = ""))

write_csv(nafo_agg_OUT,
          path = paste(path, "/final_output/nafo_notlengthbased_qadj_final.csv", sep = ""))

write_csv(nafo_length_OUT,
          path = paste(path, "/final_output/nafo_lengthbased_qadj_final.csv", sep = ""))

write_csv(strat_agg_OUT,
          path = paste(path, "/final_output/strat_notlengthbased_qadj_final.csv", sep = ""))

write_csv(strat_length_OUT,
          path = paste(path, "/final_output/strat_lengthbased_qadj_final.csv", sep = ""))


# LENGTH-WEIGHT ---------------------------------------------------

# import LW data from SSdata output
## and convert herring lengths to total length in cm
lw_esswss <-  read_csv(paste(path, "/output/LengthWeight/esswss_LengthWeight.csv", sep = "")) %>% 
 convert_herring_length() %>% 
  arrange(ID, YEAR, SPECIES, LENGTH)

# import LW data from SSdata output
## and convert herring lengths to total length in cm
lw_nafo <-  read_csv(paste(path, "/output/LengthWeight/nafo_LengthWeight.csv", sep = "")) %>% 
  convert_herring_length() %>% 
  arrange(ID, YEAR, SPECIES, LENGTH)

# import LW data from SSdata output
## and convert herring lengths to total length in cm
lw_strat <-  read_csv(paste(path, "/output/LengthWeight/strat_LengthWeight.csv", sep = "")) %>% 
  convert_herring_length() %>% 
  arrange(ID, YEAR, SPECIES, LENGTH)

# Export ------------------------------------------------------------------

write_csv(lw_esswss, 
          path = paste(path, "/final_output/esswss_LengthWeight.csv", sep = ""))

write_csv(lw_nafo, 
          path = paste(path, "/final_output/nafo_LengthWeight.csv", sep = ""))

write_csv(lw_strat, 
          path = paste(path, "/final_output/strat_LengthWeight.csv", sep = ""))


```
    
      
## calculate NAFO indicators                          
```{r}
path <- file.path(here())

source(paste(path, "/Extra Info/get_NA_index_add_NAs.R", sep = ""))

dir.create(paste(path, "/INDICATORS", sep = ""), recursive = FALSE, showWarnings = FALSE)
export.filepath <- file.path(paste(path, "/INDICATORS", sep  = ""))

start_year <- 1970
end_year <- 2022
ind.years <- c(start_year:end_year)

# Extra data
species.groups <-  read.csv(paste(path, "/Extra Info/SpeciesGroups.csv", sep = ""), header = TRUE, sep = ",")
species.info <-  read.csv(paste(path, "/Extra Info/SpeciesInfo.csv", sep = ""), header = TRUE, sep = ",")

# Group names
ratio.groups <- data.frame(rbind(c("PELAGIC", "GROUNDFISH"), c("PREDATORS", "ALL")))
names(ratio.groups) <- c("group1", "group2")

trophicguild.groups <- c("LBENTHIVORE", "MBENTHIVORE", "PISCIVORE", "PLANKTIVORE", "ZOOPISCIVORE")

condition.groups <- c("FINFISH", "LBENTHIVORE", "MBENTHIVORE", "PISCIVORE", "PLANKTIVORE", "ZOOPISCIVORE")

# resource potential
resource.groups <- c("ALL", "CLUPEIDS", "FINFISH", "FLATFISH", "FORAGE", 
                     "GADOIDS", "GROUNDFISH", "PELAGIC", "SKATES")

# allIndicators
minTL <- c(0, 3.25)
landings.groups <- c("ALL", "CLUPEIDS.L", "FINFISH.L", "FLATFISH.L", "FORAGE.L",
                     "GADOIDS.L", "GROUNDFISH.L", "INVERTEBRATES.L","LARGE_PELAGIC.L",  "SKATES.L")
FP.groups <- data.frame(rbind(c("ALL", "ALL"), 
                              c("CLUPEIDS", "CLUPEIDS.L"),
                              c("FINFISH", "FINFISH.L"),
                              c("FLATFISH", "FLATFISH.L"),
                              c("FORAGE", "FORAGE.L"),
                              c("GADOIDS", "GADOIDS.L"),
                              c("GROUNDFISH", "GROUNDFISH.L"),
                              c("SKATES", "SKATES.L")))
names(FP.groups) <- c("group.X", "group.land")

# NAFO Data ------------------------------------------------------------------

area <- "nafo"

# fishery-independent data
RV <- read.csv(paste(path, "/final_output/nafo_notlengthbased_qadj_final.csv", sep = ""), 
               head = TRUE, sep = ",", stringsAsFactors = FALSE)
RV_length <- read.csv(paste(path, "/final_output/nafo_lengthbased_qadj_final.csv", sep = ""), 
                      head = TRUE, sep = ",", stringsAsFactors = FALSE)

# commercial landings data
# landings converted from tonnes to kg to be on the same scale as the RV data (required for the FP indicators)
land <- read.csv(paste(path, "/output/Landings/nafo_land.csv", sep = ""), 
                 head = TRUE, sep = ",", stringsAsFactors = FALSE) %>% 
  mutate(CATCH = CATCH * 1000)

Length_Weight <- read.csv(paste(path, "/final_output/nafo_LengthWeight.csv", sep = ""),
                          header = TRUE, sep = ",",
                          stringsAsFactors = FALSE) # read in length-at-weight data for ESS and WSS


#  Most indicators --------------------------------------------------------

# inds <- extractAll(X = RV, 
#                    X_length = RV_length, 
#                    land = land, 
#                    years = ind.years,
#                    speciesinfo.table = species.info,
#                    species.table = species.groups,
#                    metric.bio = "ABUNDANCE", 
#                    group.bio = c("ALL", "GROUNDFISH"), 
#                    minTL.bio = 3,
#                    LSI.group = "ALL", 
#                    max.length = 85, 
#                   LFI.group = "ALL", 
#                    large.fish = 35,
#                             LenWt.table = Length_Weight,
#                             condition.groups = condition.groups, 
#                             guild.groups = trophicguild.groups,
#                             ratio.groups = ratio.groups,
#                             maxlength.group = "FINFISH",  
#                             TL.grouping = 1, 
#                             wind = 5, 
#                             negative = FALSE,
#                             resource.groups = resource.groups,
#                             minTL.FiB = 0, 
#                             base.start = 1968, 
#                             base.end = 1970, 
#                             TE = 0.1,
#                             landings.groups = landings.groups, 
#                             FP.groups = FP.groups, 
#                             minTL.FP = c(0, 3.25),
#                             glob.env = TRUE,
#                             raw = TRUE, 
#                             std = FALSE, export.path = NULL, export.id = area)

# remove 2018 from ESS data because survey was not completed that year
# inds.ess <- inds %>% filter(ID != "4X", YEAR != 2018)
# inds.wss <- inds %>% filter(ID == "4X")
# inds <- rbind(inds.ess, inds.wss)


#the extractAll produces error 
#Biodiversity, Structure and Functioning, Stability and Resistance, Resource Potential, and Fishing Pressure

# allBiodiversity
inds_biodiv<-allBiodiversity(X=RV,
                             metric="ABUNDANCE", 
                             groups="ALL",
                             percentiles= c(0.25, 0.75),
                             minTL=0, 
                             TL.table=NULL,
                             year=ind.years,
                             raw=TRUE,
                             std=TRUE,
                             glob.env=TRUE
                             )


inds_struct<-allStructure( X=RV,
  X_length=RV_length,
  LSI.group="ALL",
  LFI.group="ALL",
  max.length = 85,
  large.fish = 35,
  guild.groups=trophicguild.groups,
  condition.groups=condition.groups,
  ratio.groups=ratio.groups,
  species.table=species.groups,
  speciesinfo.table=species.table,
  LenWt.table=Length_Weight,
  years=ind.years,
  raw = TRUE,
  std = TRUE,
  glob.env = TRUE,
  export.path = NULL,
  export.id = NULL
)

inds_stab<-allStability(X=RV,
  land=land,
  maxlength.group = "FINFISH",
  species.table = species.groups,
  speciesinfo.table = species.info,
  TL.grouping = 1,
  wind = 5,
  negative = FALSE,
  years=ind.years,
  raw = TRUE,
  std = TRUE,
  glob.env = TRUE,
  export.path = NULL,
  export.id = NULL
)

inds_press<-allPressure( X=RV,
  land=land,
  species.table = species.groups,
  speciesinfo.table = species.info,
  landings.groups = landings.groups,
  FP.groups = FP.groups,
  minTL = c(0, 3.25),
  years=ind.years,
  raw = TRUE,
  std = TRUE,
  glob.env = TRUE,
  export.path = NULL,
  export.id = NULL
)

inds_pote<-allPotential(X=RV,
  land = land,
  species.table = species.groups,
  speciesinfo.table= species.info,
  resource.groups = resource.groups,
  minTL = 0,
  TE = 0.1,
  base.start= 1968,
  base.end = 1970,
  years = ind.years,
  raw = TRUE,
  std = TRUE,
  glob.env = TRUE,
  export.path = NULL,
  export.id = NULL
  )

#Need to join tables here****
inds<-inds_biodiv %>%
  left_join(inds_pote, by = c("ID", "YEAR")) %>%
  left_join(inds_press, by =c("ID", "YEAR")) %>%
  left_join(inds_stab, by = c("ID", "YEAR")) %>%
  left_join(inds_struct, by =c("ID", "YEAR")) 

# save YEAR and ID to add into inds_imp dataframe
YEAR <- inds$YEAR
ID <- inds$ID

##something weird here no Biomass_TL2 in dataframe.
# BIOMASS_TL2 because only using values after 1998 (added back in to allIndicators below)
# BIOMASS_TL2 <- inds %>% 
#   dplyr::select(YEAR, ID, BIOMASS_TL2) %>% 
#   filter(YEAR >= 1999)
# 
# # remove BIOMASS_TL2 from inds so it is not used in the imputation (consistent with esswss)
# inds <- inds %>% dplyr::select(-BIOMASS_TL2)

# record which indicators have >25% NA for given area
# these indicators will be filtered out after the imputation
NA_index <- get_NA_index(inds)
NA_index_output <- pivot_wider(NA_index, names_from = col_index, values_from = fraction_NA)
names(NA_index_output)[1] = "NAFO_Area"
write.csv(NA_index_output, file = paste(export.filepath, "/fraction_NA_", area, ".csv", sep = ""),
          row.names = FALSE)

# imputation to fill in missing values
set.seed(22)
inds_imp <- inds %>% 
  dplyr::select(-YEAR, -ID) %>% 
  as.matrix() %>% 
  missForest()

inds_imp <- inds_imp$ximp %>% 
  data.frame() %>% 
  mutate(YEAR = YEAR, ID = ID) %>% 
  dplyr::select(YEAR, ID, everything())

# filter out indicators with >25% NA for a given area
# this function uses the NA_index dataframe to find indicators for each strata that
## had >25% NAs before imputation. All values for these indicators are replaced with
## NA, essentially filtering out these indicators
inds_filtered <- add_NAs(inds_imp, NA_index)
rm(inds, inds_imp)


# Invertebrate indicators -------------------------------------------------

# the above calculates everything EXCEPT invertebrate-related indicators 
## (because we want to start the invertebrate indicators in 1999)

# invertebrate biomass
inverts <- resourcePotential(RV, groups = "INVERTEBRATES", species.table = species.groups, 
                             metric = "BIOMASS", years = c(1999:end_year))

# invertebrate to demersal ratio
invert_dem <- data.frame(rbind(c("INVERTEBRATES", "GROUNDFISH")))
names(invert_dem) <- c("group1", "group2")
invert_demersal_ratio <- biomassRatio(RV, ratio.groups = invert_dem, 
                                      species.table = species.groups, 
                                      metric = "BIOMASS", years = c(1999:end_year))

# fishing pressure on inverts
FP.groups.inverts <- data.frame(rbind(c("INVERTEBRATES", "INVERTEBRATES.L")))
names(FP.groups.inverts) <- c("group.X", "group.land")
FP_inverts <- fishingPressure(RV, land, FP.groups = FP.groups.inverts, species.table = species.groups,
                              years = c(1999:end_year))

short_inds <- full_join(inverts, invert_demersal_ratio, by = c("YEAR", "ID")) %>% 
  full_join(FP_inverts, by = c("YEAR", "ID"))

# %>% 
#   full_join(BIOMASS_TL2, by = c("YEAR", "ID"))

# remove 2018 from ESS data because survey was not completed that year
# short_inds.ess <- short_inds %>% filter(ID != "4X", YEAR != 2018)
# short_inds.wss <- short_inds %>% filter(ID == "4X")
# short_inds <- rbind(short_inds.ess, short_inds.wss)
# rm(short_inds.ess, short_inds.wss)

# record which indicators have >25% NA for given strata
# these indicators will be filtered out after the imputation
NA_index_short <- get_NA_index(short_inds)

# Export -----------------------------------------------------------------

eco_indicators_nafo <- left_join(inds_filtered, short_inds, by = c("YEAR", "ID")) 

write.csv(eco_indicators_nafo, file = paste(export.filepath, "/eco_indicators_", area, ".csv", sep = ""),
          row.names = FALSE)
save(eco_indicators_nafo, file=here("INDICATORS", "eco_indicators_nafo.Rdata"))


```
## calculate SS indicators
 
```{r}
path <- file.path(here())

source(paste(path, "/Extra Info/get_NA_index_add_NAs.R", sep = ""))

dir.create(paste(path, "/INDICATORS", sep = ""), recursive = FALSE, showWarnings = FALSE)
export.filepath <- file.path(paste(path, "/INDICATORS", sep  = ""))

start_year <- 1970
end_year <- 2022
ind.years <- c(start_year:end_year)

# Extra data
species.groups <-  read.csv(paste(path, "/Extra Info/SpeciesGroups.csv", sep = ""), header = TRUE, sep = ",")
species.info <-  read.csv(paste(path, "/Extra Info/SpeciesInfo.csv", sep = ""), header = TRUE, sep = ",")

# Group names
ratio.groups <- data.frame(rbind(c("PELAGIC", "GROUNDFISH"), c("PREDATORS", "ALL")))
names(ratio.groups) <- c("group1", "group2")

trophicguild.groups <- c("LBENTHIVORE", "MBENTHIVORE", "PISCIVORE", "PLANKTIVORE", "ZOOPISCIVORE")

condition.groups <- c("FINFISH", "LBENTHIVORE", "MBENTHIVORE", "PISCIVORE", "PLANKTIVORE", "ZOOPISCIVORE")

# resource potential
resource.groups <- c("ALL", "CLUPEIDS", "FINFISH", "FLATFISH", "FORAGE", 
                     "GADOIDS", "GROUNDFISH", "PELAGIC", "SKATES")

# allIndicators
minTL <- c(0, 3.25)
landings.groups <- c("ALL", "CLUPEIDS.L", "FINFISH.L", "FLATFISH.L", "FORAGE.L",
                     "GADOIDS.L", "GROUNDFISH.L", "INVERTEBRATES.L","LARGE_PELAGIC.L",  "SKATES.L")
FP.groups <- data.frame(rbind(c("ALL", "ALL"), 
                              c("CLUPEIDS", "CLUPEIDS.L"),
                              c("FINFISH", "FINFISH.L"),
                              c("FLATFISH", "FLATFISH.L"),
                              c("FORAGE", "FORAGE.L"),
                              c("GADOIDS", "GADOIDS.L"),
                              c("GROUNDFISH", "GROUNDFISH.L"),
                              c("SKATES", "SKATES.L")))
names(FP.groups) <- c("group.X", "group.land")

# NAFO Data ------------------------------------------------------------------

area <- "esswss"

# fishery-independent data
RV <- read.csv(paste(path, "/final_output/esswss_notlengthbased_qadj_final.csv", sep = ""), 
               head = TRUE, sep = ",", stringsAsFactors = FALSE)
RV_length <- read.csv(paste(path, "/final_output/esswss_lengthbased_qadj_final.csv", sep = ""), 
                      head = TRUE, sep = ",", stringsAsFactors = FALSE)

# commercial landings data
# landings converted from tonnes to kg to be on the same scale as the RV data (required for the FP indicators)
land <- read.csv(paste(path, "/output/Landings/esswss_land.csv", sep = ""), 
                 head = TRUE, sep = ",", stringsAsFactors = FALSE) %>% 
  mutate(CATCH = CATCH * 1000)

Length_Weight <- read.csv(paste(path, "/final_output/esswss_LengthWeight.csv", sep = ""),
                          header = TRUE, sep = ",",
                          stringsAsFactors = FALSE) # read in length-at-weight data for ESS and WSS


#  Most indicators --------------------------------------------------------

# inds <- extractAll(X = RV, 
#                    X_length = RV_length, 
#                    land = land, 
#                    years = ind.years,
#                    speciesinfo.table = species.info,
#                    species.table = species.groups,
#                    metric.bio = "ABUNDANCE", 
#                    group.bio = c("ALL", "GROUNDFISH"), 
#                    minTL.bio = 3,
#                    LSI.group = "ALL", 
#                    max.length = 85, 
#                   LFI.group = "ALL", 
#                    large.fish = 35,
#                             LenWt.table = Length_Weight,
#                             condition.groups = condition.groups, 
#                             guild.groups = trophicguild.groups,
#                             ratio.groups = ratio.groups,
#                             maxlength.group = "FINFISH",  
#                             TL.grouping = 1, 
#                             wind = 5, 
#                             negative = FALSE,
#                             resource.groups = resource.groups,
#                             minTL.FiB = 0, 
#                             base.start = 1968, 
#                             base.end = 1970, 
#                             TE = 0.1,
#                             landings.groups = landings.groups, 
#                             FP.groups = FP.groups, 
#                             minTL.FP = c(0, 3.25),
#                             glob.env = TRUE,
#                             raw = TRUE, 
#                             std = FALSE, export.path = NULL, export.id = area)

# remove 2018 from ESS data because survey was not completed that year
# inds.ess <- inds %>% filter(ID != "4X", YEAR != 2018)
# inds.wss <- inds %>% filter(ID == "4X")
# inds <- rbind(inds.ess, inds.wss)


#the extractAll produces error 
#Biodiversity, Structure and Functioning, Stability and Resistance, Resource Potential, and Fishing Pressure

# allBiodiversity
inds_biodiv<-allBiodiversity(X=RV,
                             metric="ABUNDANCE", 
                             groups="ALL",
                             percentiles= c(0.25, 0.75),
                             minTL=0, 
                             TL.table=NULL,
                             year=ind.years,
                             raw=TRUE,
                             std=TRUE,
                             glob.env=TRUE
                             )


inds_struct<-allStructure( X=RV,
  X_length=RV_length,
  LSI.group="ALL",
  LFI.group="ALL",
  max.length = 85,
  large.fish = 35,
  guild.groups=trophicguild.groups,
  condition.groups=condition.groups,
  ratio.groups=ratio.groups,
  species.table=species.groups,
  speciesinfo.table=species.table,
  LenWt.table=Length_Weight,
  years=ind.years,
  raw = TRUE,
  std = TRUE,
  glob.env = TRUE,
  export.path = NULL,
  export.id = NULL
)

inds_stab<-allStability(X=RV,
  land=land,
  maxlength.group = "FINFISH",
  species.table = species.groups,
  speciesinfo.table = species.info,
  TL.grouping = 1,
  wind = 5,
  negative = FALSE,
  years=ind.years,
  raw = TRUE,
  std = TRUE,
  glob.env = TRUE,
  export.path = NULL,
  export.id = NULL
)

inds_press<-allPressure( X=RV,
  land=land,
  species.table = species.groups,
  speciesinfo.table = species.info,
  landings.groups = landings.groups,
  FP.groups = FP.groups,
  minTL = c(0, 3.25),
  years=ind.years,
  raw = TRUE,
  std = TRUE,
  glob.env = TRUE,
  export.path = NULL,
  export.id = NULL
)

inds_pote<-allPotential(X=RV,
  land = land,
  species.table = species.groups,
  speciesinfo.table= species.info,
  resource.groups = resource.groups,
  minTL = 0,
  TE = 0.1,
  base.start= 1968,
  base.end = 1970,
  years = ind.years,
  raw = TRUE,
  std = TRUE,
  glob.env = TRUE,
  export.path = NULL,
  export.id = NULL
  )

#Need to join tables here****
inds<-inds_biodiv %>%
  left_join(inds_pote, by = c("ID", "YEAR")) %>%
  left_join(inds_press, by =c("ID", "YEAR")) %>%
  left_join(inds_stab, by = c("ID", "YEAR")) %>%
  left_join(inds_struct, by =c("ID", "YEAR")) 

# save YEAR and ID to add into inds_imp dataframe
YEAR <- inds$YEAR
ID <- inds$ID

##something weird here no Biomass_TL2 in dataframe.
# BIOMASS_TL2 because only using values after 1998 (added back in to allIndicators below)
# BIOMASS_TL2 <- inds %>% 
#   dplyr::select(YEAR, ID, BIOMASS_TL2) %>% 
#   filter(YEAR >= 1999)
# 
# # remove BIOMASS_TL2 from inds so it is not used in the imputation (consistent with esswss)
# inds <- inds %>% dplyr::select(-BIOMASS_TL2)

# record which indicators have >25% NA for given area
# these indicators will be filtered out after the imputation
NA_index <- get_NA_index(inds)
NA_index_output <- pivot_wider(NA_index, names_from = col_index, values_from = fraction_NA)
names(NA_index_output)[1] = "NAFO_Area"
write.csv(NA_index_output, file = paste(export.filepath, "/fraction_NA_", area, ".csv", sep = ""),
          row.names = FALSE)

# imputation to fill in missing values
set.seed(22)
inds_imp <- inds %>% 
  dplyr::select(-YEAR, -ID) %>% 
  as.matrix() %>% 
  missForest()

inds_imp <- inds_imp$ximp %>% 
  data.frame() %>% 
  mutate(YEAR = YEAR, ID = ID) %>% 
  dplyr::select(YEAR, ID, everything())

# filter out indicators with >25% NA for a given area
# this function uses the NA_index dataframe to find indicators for each strata that
## had >25% NAs before imputation. All values for these indicators are replaced with
## NA, essentially filtering out these indicators
inds_filtered <- add_NAs(inds_imp, NA_index)
rm(inds, inds_imp)


# Invertebrate indicators -------------------------------------------------

# the above calculates everything EXCEPT invertebrate-related indicators 
## (because we want to start the invertebrate indicators in 1999)

# invertebrate biomass
inverts <- resourcePotential(RV, groups = "INVERTEBRATES", species.table = species.groups, 
                             metric = "BIOMASS", years = c(1999:end_year))

# invertebrate to demersal ratio
invert_dem <- data.frame(rbind(c("INVERTEBRATES", "GROUNDFISH")))
names(invert_dem) <- c("group1", "group2")
invert_demersal_ratio <- biomassRatio(RV, ratio.groups = invert_dem, 
                                      species.table = species.groups, 
                                      metric = "BIOMASS", years = c(1999:end_year))

# fishing pressure on inverts
FP.groups.inverts <- data.frame(rbind(c("INVERTEBRATES", "INVERTEBRATES.L")))
names(FP.groups.inverts) <- c("group.X", "group.land")
FP_inverts <- fishingPressure(RV, land, FP.groups = FP.groups.inverts, species.table = species.groups,
                              years = c(1999:end_year))

short_inds <- full_join(inverts, invert_demersal_ratio, by = c("YEAR", "ID")) %>% 
  full_join(FP_inverts, by = c("YEAR", "ID"))

# %>% 
#   full_join(BIOMASS_TL2, by = c("YEAR", "ID"))

# remove 2018 from ESS data because survey was not completed that year
# short_inds.ess <- short_inds %>% filter(ID != "4X", YEAR != 2018)
# short_inds.wss <- short_inds %>% filter(ID == "4X")
# short_inds <- rbind(short_inds.ess, short_inds.wss)
# rm(short_inds.ess, short_inds.wss)

# record which indicators have >25% NA for given strata
# these indicators will be filtered out after the imputation
NA_index_short <- get_NA_index(short_inds)

# Export -----------------------------------------------------------------

# allIndicators <- left_join(inds_filtered, short_inds, by = c("YEAR", "ID")) 

eco_indicators_esswss <- left_join(inds, short_inds, by = c("YEAR", "ID")) 

write.csv(eco_indicators_esswss, file = paste(export.filepath, "/eco_indicators_", area, ".csv", sep = ""),
          row.names = FALSE)

save(eco_indicators_esswss, file=paste(export.filepath, "/eco_indicators_", area, ".Rdata", sep = ""))


```
                          